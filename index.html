<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Wrist Ray AR</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
}

video, canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  pointer-events: none;
}

#start {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background: black;
  color: white;
  font-size: 36px;
  z-index: 9999;
  cursor: pointer;
}
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="start">TAP TO START</div>

<script>
const startBtn = document.getElementById("start");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

canvas.width = innerWidth;
canvas.height = innerHeight;

let pose;

// START
startBtn.onclick = async () => {
  await document.documentElement.requestFullscreen?.();
  startBtn.remove();
  startCamera();
};

async function startCamera() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  const backCam = devices.find(d =>
    d.kind === "videoinput" && d.label.toLowerCase().includes("back")
  );

  const stream = await navigator.mediaDevices.getUserMedia({
    video: backCam
      ? { deviceId: { exact: backCam.deviceId } }
      : { facingMode: "environment" },
    audio: false
  });

  video.srcObject = stream;

  pose = new Pose({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
  });

  pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  pose.onResults(drawRay);

  const loop = async () => {
    if (video.readyState >= 2) await pose.send({ image: video });
    requestAnimationFrame(loop);
  };
  loop();
}

// DRAW STRAIGHT RAY FROM WRIST
function drawRay(results) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!results.poseLandmarks) return;

  // RIGHT WRIST ONLY
  const wrist = results.poseLandmarks[16];
  if (!wrist || wrist.visibility < 0.5) return;

  const wx = wrist.x * canvas.width;
  const wy = wrist.y * canvas.height;

  // Direction: straight forward (upwards on screen)
  const dx = 0;
  const dy = -1;

  // Find wall hit
  let t = Infinity;
  if (dy < 0) t = wy / -dy;
  if (dy > 0) t = (canvas.height - wy) / dy;
  if (dx < 0) t = Math.min(t, wx / -dx);
  if (dx > 0) t = Math.min(t, (canvas.width - wx) / dx);

  const hitX = wx + dx * t;
  const hitY = wy + dy * t;

  // Draw straight line
  ctx.beginPath();
  ctx.moveTo(wx, wy);
  ctx.lineTo(hitX, hitY);
  ctx.strokeStyle = "lime";
  ctx.lineWidth = 4;
  ctx.stroke();

  // Draw wall hit
  ctx.beginPath();
  ctx.arc(hitX, hitY, 40, 0, Math.PI * 2);
  ctx.fillStyle = "red";
  ctx.fill();
}
</script>

</body>
</html>
